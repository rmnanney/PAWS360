{
  "info": {
    "name": "PAWS360 Users • Create, Assign & Enroll",
    "_postman_id": "paws360-users-assign-enroll",
    "description": "Creates users (professor, instructor, TA, students), ensures target courses/sections exist, assigns staff to sections, and enrolls students into lecture + lab. Configure base_url and optional studentId mapping in environment.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Users → Create, Assign Staff, Enroll Students",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "https://postman-echo.com/get",
          "protocol": "https",
          "host": ["postman-echo","com"],
          "path": ["get"]
        },
        "description": "Pre-request script performs all operations against your backend. Set env base_url (default http://localhost:8080). To enroll students, provide env var studentIds JSON mapping: {\"alice.student@uwm.edu\":1,...}."
      },
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "(async () => {",
              "  // ---------- Configuration ----------",
              "  const BASE = pm.environment.get('base_url') || 'http://localhost:8080';",
              "  const TERM = pm.environment.get('seedTerm') || 'Fall';",
              "  const YEAR = parseInt(pm.environment.get('seedAcademicYear') || '2025', 10);",
              "  const COURSES_TO_USE = (pm.environment.get('seedUserCourseCodes') || 'COMPSCI 101,MATH 101,PHYSICS 101').split(',').map(s=>s.trim()).filter(Boolean);",
              "  // If you want to override lab codes/lecture code:",
              "  const LECTURE_CODE = pm.environment.get('seedLectureCode') || '001';",
              "  const LAB_CODES = (pm.environment.get('seedLabCodes') || '201,202').split(',').map(s=>s.trim());",
              "  const LECTURE_CAP = parseInt(pm.environment.get('seedLectureCap') || '40', 10);",
              "  const LAB_CAP = parseInt(pm.environment.get('seedLabCap') || '20', 10);",
              "  const WAITLIST_CAP = parseInt(pm.environment.get('seedWaitlistCap') || '10', 10);",
              "  // Users to create",
              "  const PROFESSOR = { firstname: 'Dave',  middlename: '', lastname: 'Prof',       email: 'dave.prof@uwm.edu',  role: 'PROFESSOR' };",
              "  const INSTRUCTOR= { firstname: 'Ivy',   middlename: '', lastname: 'Instructor', email: 'ivy.inst@uwm.edu',   role: 'INSTRUCTOR' };",
              "  const TA        = { firstname: 'Bob',   middlename: '', lastname: 'TA',         email: 'bob.ta@uwm.edu',     role: 'TA' };",
              "  const STUDENTS  = [",
              "    { firstname: 'Alice', middlename: '', lastname: 'Student', email: 'alice.student@uwm.edu' },",
              "    { firstname: 'Eve',   middlename: '', lastname: 'Pupil',   email: 'eve.pupil@uwm.edu'     },",
              "    { firstname: 'Tom',   middlename: '', lastname: 'Learner', email: 'tom.learner@uwm.edu'   },",
              "    { firstname: 'Sara',  middlename: '', lastname: 'Scholar', email: 'sara.scholar@uwm.edu'  }",
              "  ];",
              "  const sleep = (ms) => new Promise(r => setTimeout(r, ms));",
              "  const log = (...a) => console.log('[USERS SEED]', ...a);",
              "  async function post(path, body, headers = { 'Content-Type': 'application/json' }) {",
              "    return new Promise(resolve => {",
              "      pm.sendRequest({ url: BASE + path, method: 'POST', header: headers, body: { mode:'raw', raw: JSON.stringify(body) } }, (err, res) => {",
              "        if (err || !res) return resolve({ ok:false, status:0, json:null });",
              "        let data = null; try { data = res.json(); } catch(e) {}",
              "        resolve({ ok: res.code >= 200 && res.code < 300, status: res.code, json: data });",
              "      });",
              "    });",
              "  }",
              "  async function get(path) {",
              "    return new Promise(resolve => {",
              "      pm.sendRequest({ url: BASE + path, method: 'GET' }, (err, res) => {",
              "        if (err || !res) return resolve({ ok:false, status:0, json:null });",
              "        let data = null; try { data = res.json(); } catch(e) {}",
              "        resolve({ ok: res.code >= 200 && res.code < 300, status: res.code, json: data });",
              "      });",
              "    });",
              "  }",
              "  async function createUser(u, role) {",
              "    const body = {",
              "      firstname: u.firstname, middlename: u.middlename || '', lastname: u.lastname,",
              "      dob: '1990-01-01', email: u.email, password: 'Password123!',",
              "      addresses: [{ id: null, address_type: 'HOME', street_address_1: '123 University Ave', street_address_2: '', po_box:'', city:'Milwaukee', us_states:'WI', zipcode:'53201' }],",
              "      countryCode: 'US', phone:'4145550000', status:'ACTIVE', role",
              "    };",
              "    const r = await post('/users/create', body);",
              "    if (!r.ok) { log('Create user failed', u.email, r.status); return null; }",
              "    return r.json.user_id;",
              "  }",
              "  async function ensureCourse(courseCode) {",
              "    const subj = courseCode.replace(/\s+.*/, '');",
              "    const num  = (courseCode.match(/(\\d+)/)||[])[1] || '101';",
              "    const level= String(Math.floor(parseInt(num,10)/100)*100);",
              "    const body = {",
              "      courseCode, courseName: courseCode + ' (Seeded)', courseDescription: 'Auto created by user seeder',",
              "      departmentCode: subj, courseLevel: level, creditHours: (subj==='CHEM'||subj==='PHYSICS')?4.0:3.0,",
              "      deliveryMethod: 'IN_PERSON', active: true, catalogMaxEnrollment: 200, academicYear: YEAR, term: TERM",
              "    };",
              "    const r = await post('/courses', body);",
              "    if (!r.ok) { log('Upsert course failed', courseCode, r.status); return null; }",
              "    return r.json.courseId;",
              "  }",
              "  async function getCourse(courseId){ const r = await get('/courses/'+courseId); return r.ok ? r.json : null; }",
              "  async function upsertSection(req){ const r = await post('/courses/sections', req); if (!r.ok) { log('Section upsert failed', req.courseId, req.sectionType, req.sectionCode, r.status); return null; } return r.json.sectionId; }",
              "  async function assignStaff(sectionId, userId, role){ const r = await post('/courses/sections/assign-staff',{ sectionId, userId, role }); return !!r.ok; }",
              "  async function enrollStudent(studentId, lectureId, labId){ const r = await post('/enrollments/enroll',{ studentId, lectureSectionId: lectureId, labSectionId: labId }); return !!r.ok; }",
              "  // ---------- Create users ----------",
              "  const professorId = await createUser(PROFESSOR, PROFESSOR.role); await sleep(20);",
              "  const instructorId= await createUser(INSTRUCTOR, INSTRUCTOR.role); await sleep(20);",
              "  const taId        = await createUser(TA, TA.role); await sleep(20);",
              "  const studentUserIds = {};",
              "  for (const s of STUDENTS){ const id = await createUser(s, 'STUDENT'); if (id) studentUserIds[s.email] = id; await sleep(15);} ",
              "  log('Users created',{ professorId, instructorId, taId, studentUserIds });",
              "  // ---------- Ensure courses & sections, then assign and enroll ----------",
              "  // Student ID mapping: provide env var 'studentIds' as JSON like {\"alice.student@uwm.edu\":1,...}",
              "  let studentIdMap = {};",
              "  try { const s = pm.environment.get('studentIds'); if (s) studentIdMap = JSON.parse(s); } catch(e) { log('Invalid studentIds env JSON'); }",
              "  const summary = [];",
              "  for (const code of COURSES_TO_USE){",
              "    const courseId = await ensureCourse(code); if (!courseId) { continue; }",
              "    const existing = await getCourse(courseId);",
              "    // Create/find lecture",
              "    let lectureId = null;",
              "    if (existing?.sections?.length){",
              "      const mm = existing.sections.find(s=> s.sectionType==='LECTURE' && s.sectionCode===LECTURE_CODE && s.term===TERM && s.academicYear===YEAR );",
              "      if (mm) lectureId = mm.sectionId;",
              "    }",
              "    if (!lectureId){",
              "      lectureId = await upsertSection({ sectionId:null, courseId, sectionCode: LECTURE_CODE, sectionType:'LECTURE', parentSectionId:null, buildingId:null, classroomId:null, meetingDays:['MONDAY','WEDNESDAY'], startTime:'09:30:00', endTime:'10:45:00', maxEnrollment: LECTURE_CAP, waitlistCapacity: WAITLIST_CAP, autoEnrollWaitlist:true, consentRequired:false, term:TERM, academicYear:YEAR });",
              "    }",
              "    // Assign professor/instructor",
              "    if (lectureId && (professorId || instructorId)) { const staffId = professorId || instructorId; await assignStaff(lectureId, staffId, professorId?'PROFESSOR':'INSTRUCTOR'); }",
              "    // Create/find labs",
              "    const labIds = [];",
              "    for (const labCode of LAB_CODES){",
              "      let labId = null;",
              "      if (existing?.sections?.length){ const mm = existing.sections.find(s=> s.sectionType==='LAB' && s.sectionCode===labCode && s.term===TERM && s.academicYear===YEAR ); if (mm) labId = mm.sectionId; }",
              "      if (!labId){ labId = await upsertSection({ sectionId:null, courseId, sectionCode: labCode, sectionType:'LAB', parentSectionId: lectureId, buildingId:null, classroomId:null, meetingDays:['TUESDAY'], startTime:'11:00:00', endTime:'12:15:00', maxEnrollment: LAB_CAP, waitlistCapacity: WAITLIST_CAP, autoEnrollWaitlist:true, consentRequired:false, term:TERM, academicYear:YEAR }); }",
              "      if (labId) { labIds.push(labId); if (taId) await assignStaff(labId, taId, 'TEACHING_ASSISTANT'); }",
              "      await sleep(10);",
              "    }",
              "    // Enroll students (requires env studentIds mapping) → split across labs",
              "    const emails = Object.keys(studentUserIds);",
              "    let li = 0;",
              "    const enrollResults = [];",
              "    for (const em of emails){",
              "      const sid = studentIdMap[em];",
              "      if (!sid){ enrollResults.push({ email: em, status: 'skipped', reason: 'missing studentId mapping (env studentIds)' }); continue; }",
              "      const labId = labIds.length ? labIds[li % labIds.length] : null; li++;",
              "      const ok = await enrollStudent(sid, lectureId, labId);",
              "      enrollResults.push({ email: em, ok });",
              "      await sleep(10);",
              "    }",
              "    summary.push({ courseCode: code, courseId, lectureId, labIds, enrollResults });",
              "    await sleep(20);",
              "  }",
              "  pm.environment.set('user_seed_summary', JSON.stringify(summary));",
              "  if (!Object.keys(studentIdMap).length) {",
              "    console.warn('[USERS SEED] NOTE: Provide env var studentIds JSON mapping {email: studentId} to enable auto-enrollment.');",
              "  }",
              "})().catch(err => console.log('[USERS SEED] Uncaught error', err));"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const s = pm.environment.get('user_seed_summary');",
              "if (s) { console.log('[USERS SEED] Summary', s); pm.test('User seeding finished', function(){ pm.expect(true).to.be.true; }); }",
              "else { pm.test('User seeding started (async)', function(){ pm.expect(true).to.be.true; }); }"
            ]
          }
        }
      ]
    }
  ],
  "variable": [
    { "key": "base_url", "value": "http://localhost:8080" },
    { "key": "seedAcademicYear", "value": "2025" },
    { "key": "seedTerm", "value": "Fall" },
    { "key": "seedLectureCap", "value": "40" },
    { "key": "seedLabCap", "value": "20" },
    { "key": "seedWaitlistCap", "value": "10" },
    { "key": "seedUserCourseCodes", "value": "COMPSCI 101,MATH 101,PHYSICS 101" },
    { "key": "seedLectureCode", "value": "001" },
    { "key": "seedLabCodes", "value": "201,202" },
    { "key": "studentIds", "value": "" }
  ]
}

