#!/bin/bash
# GitHub Actions Runner Registration Script
# Generated by Ansible for {{ runner_name }}

RUNNER_DIR="{{ runner_work_dir }}"
GITHUB_URL="https://github.com/{{ github_org }}/{{ github_repo }}"
RUNNER_NAME="{{ runner_name }}"
RUNNER_LABELS="{{ runner_labels }}"

if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <REGISTRATION_TOKEN>"
    echo ""
    echo "Get registration token with:"
    echo "  gh api --method POST -H 'Accept: application/vnd.github+json' \\"
    echo "    /repos/{{ github_org }}/{{ github_repo }}/actions/runners/registration-token"
    exit 1
fi

TOKEN="$1"

echo "üîß Configuring GitHub Actions runner..."
echo "  URL: $GITHUB_URL"
echo "  Name: $RUNNER_NAME"
echo "  Labels: $RUNNER_LABELS"

cd "$RUNNER_DIR" || exit 1

./config.sh \
  --url "$GITHUB_URL" \
  --token "$TOKEN" \
  --name "$RUNNER_NAME" \
  --labels "$RUNNER_LABELS" \
  --work _work \
  --unattended

if [ $? -eq 0 ]; then
    echo "‚úÖ Runner configured successfully"
    echo ""
    echo "Installing service..."
    sudo ./svc.sh install {{ runner_user }}
    
    echo "Starting service..."
    sudo ./svc.sh start
    
    echo ""
    echo "‚úÖ Runner is now active!"
    echo "Verify at: https://github.com/{{ github_org }}/{{ github_repo }}/settings/actions/runners"
else
    echo "‚ùå Runner configuration failed"
    exit 1
fi
