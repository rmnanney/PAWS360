---
- name: Ensure /etc/maven directory exists
  file:
    path: /etc/maven
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Deploy Maven settings.xml with Nexus mirror
  template:
    src: settings.xml.j2
    dest: /etc/maven/settings.xml
    owner: root
    group: root
    mode: '0644'

- name: Ensure maven is installed
  package:
    name: maven
    state: present

- name: Validate Maven can go offline using mirror
  become: true
  become_user: root
  shell: |
    set -e
    if mvn -B -DskipTests -s /etc/maven/settings.xml dependency:go-offline; then
      exit 0
    else
      echo "Mirror go-offline failed, falling back to direct central"
      mvn -B -DskipTests dependency:go-offline
    fi
  args:
    chdir: /tmp
  register: mvn_offline
  failed_when: mvn_offline.rc != 0
